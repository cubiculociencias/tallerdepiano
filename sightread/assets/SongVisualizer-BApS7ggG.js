import{c as ue}from"./Dropdown-B9h-t97s.js";import{a as R,p as ne}from"./chunk-PVWAREVJ-BeAWct5i.js";import{T as he,d as ie,t as _,U as D,m as L,V as O,W as Ce,X as ee,Y as ge,Z as Le,_ as Te,$ as xe,a0 as Me,u as We}from"./context-kPolJz0x.js";import{k as Ie,m as Fe,u as He,C as Oe}from"./Canvas-C5qiJpk2.js";import{i as Ee,r as V,a as oe,g as $e,l as j,p as Y,b as Ye,d as X,S as y,c as _e,e as pe,f as me,h as ye,j as z,k as Xe,m as Be,n as Ae,o as De,q as Ke,s as re,t as se,P as we}from"./common-wRUDMAM3.js";const Ve=new Set([1,3,6,8,10]);function k(e){return Ve.has(e%12)}function je(e){return!k(e)}/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1",key:"kaeet6"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1",key:"1wsw3u"}]],Zt=ue("pause",ze);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],Jt=ue("play",Ge);function Qt(e){const t=R.useRef(null);return t.current=e,R.useEffect(()=>()=>t.current?.(),[])}function Ue(e){const t=e.program??-1;return e.instrument?.toLowerCase()?.includes("piano")||e.name?.toLowerCase()?.includes("piano")||0<=t&&t<=6}function qe(e){const t=Object.values(e.tracks).map(c=>c.name??""),n=["bass","left","lh","L.H."],i=["treble","lead","rh","right","R.H.","Student"],o=t.find(c=>n.includes(c.toLowerCase())),r=t.find(c=>i.includes(c.toLowerCase()));if(o&&r){const c=Object.keys(e.tracks).find(g=>e.tracks[g].name===o),p=Object.keys(e.tracks).find(g=>e.tracks[g].name===r);return{left:+c,right:+p}}const s=Array.from(Object.entries(e.tracks)).filter(([c,p])=>Ue(p)).filter(([c,p])=>(e.notes.filter(g=>g.track===+c),e.notes.filter(g=>g.track===+c).length>0));let l,f;s.length>=2?(s.length>2&&console.warn(`Choosing the first two Piano tracks, even though there are ${s.length}`),[l,f]=s.map(([c,p])=>+c)):s.length<2&&([l,f]=Object.keys(e.tracks).map(Number));const u=c=>c.reduce((p,g)=>p+g,0),a=c=>u(c)/c.length;let d=a(e.notes.filter(c=>c.track===l).map(c=>c.midiNote)),h=a(e.notes.filter(c=>c.track===f).map(c=>c.midiNote));return d<h?{left:l,right:f}:{left:f,right:l}}function Ze(e,t){const n=e?.notes??[];let i=n[0]?.midiNote??21,o=n[0]?.midiNote??108;for(let{midiNote:s}of n)i=Math.min(i,s),o=Math.max(o,s);const r=o-i;if(r<t){const s=Math.floor((t-r)/2);i-=s,o+=s}return i=_(i-2,{min:21,max:107}),o=_(o+2,{min:i+1,max:108}),k(i-1)&&i>21&&i--,k(o+1)&&o<108&&o++,{startNote:i,endNote:o}}function en(e){return e?he(e.tracks,t=>({hand:t.hand})):{}}function Je(e){return e.program&&e.program>=0?ie[e.program]:(e.instrument||e.name)??ie[0]}function Qe(e){const t={left:!0,right:!0,waiting:!1,noteLabels:"none",coloredNotes:!1,skipMissedNotes:!1,visualization:"falling-notes",tracks:{}};if(!e)return t;const{left:n,right:i}=et(e),o=he(e.tracks,(r,s)=>{const l=parseInt(s);return{track:r,hand:n===l?"left":i===l?"right":"none",count:e.notes.filter(u=>u.track===l).length,instrument:Je(r),sound:!0}});return t.tracks=o,t}function tn(e,t){let n=Ie(e);if(n)return n;const i=Qe(t);return Fe(e,i),i}function et(e){return qe(e)}function be(e,t,n){return tt(e.items,t,n).filter(i=>t(i)&&nt(i,e))}function tt(e,t,n){let i=e.findIndex(t);if(i===-1)return[];let o=i+1;for(;o<e.length&&!n(e[o]);o++);return e.slice(i,o)}function nt(e,t){const{hand:n,hands:i}=t;switch(e.type){case"measure":return t.visualization==="falling-notes";case"note":return(n==="both"||n==="left")&&i[e.track]?.hand==="left"||(n==="both"||n==="right")&&i[e.track]?.hand==="right"}}const ae={};function it(e,t){return`${e}-${t}`}function ot(e,t,n,i){const o=t.length;let r=1,s=i,l=r,f=0;for(;r<=s;){const u=Math.floor((r+s)/2),a=it(u,o);let d=ae[a];d==null&&(e.font=`${u}px ${n}`,d=e.measureText("M".repeat(o)).width,ae[a]=d),d<=i?(l=u,f=d,r=u+1):s=u-1}return{fontPx:l,measuredWidth:f}}let I={};function rt(e,t,n){if(I[n]?.[t])return I[n][t];const i=e.measureText(t);I[n]||(I[n]={});const o={width:i.width,height:i.fontBoundingBoxAscent+i.fontBoundingBoxDescent};return o.height||(o.height=e.measureText("M").width),I[n][t]=o,o}const te=225;let le=e=>{const t=new Image;return t.src=e,new Promise((n,i)=>{t.onload=()=>n(t),t.onerror=()=>i(t)})},G=null,K=null;function st(){return K||(K=(async()=>{const[e,t]=await Promise.all([le("/images/black-key-raised.png"),le("/images/black-key-pressed.png")]);G={blackKeyRaised:e,blackKeyPressed:t}})()),K}function at(){if(!G)throw new Error("Images not loaded â€” call await waitForImages() before rendering");return G}const lt="Arial",ct="rgb(255,253,240)";function ft(e){return{1:-.16666666666666663,3:.16666666666666663,6:-.16666666666666663,8:0,10:.16666666666666663}[e%12]}function ce(e,t){const n=t?.startNote??21,i=t?.endNote??108;let o=0;for(let h=n;h<=i;h++)je(h)&&o++;const r=e/o,s=Math.floor(Math.min(5*r,250)),l=r/2,f=Math.floor(s*(2/3)),u=r/20,a={pianoWidth:e,whiteHeight:s,blackHeight:f,whiteNoteSeparation:u,lanes:{}};let d=0;for(let h=n;h<=i;h++)if(k(h)){const c=r*d,p=c-l/2-2+ft(h)*l;a.lanes[h]={width:l,left:p,whiteMiddle:c}}else a.lanes[h]={width:r,left:r*d},d++;return a}async function dt(e,t,n,i){const{whiteHeight:o,whiteNoteSeparation:r,blackHeight:s,lanes:l}=t;e.save();const f=Object.entries(l).filter(([a])=>!k(+a)),u=Object.entries(l).filter(([a])=>k(+a));e.strokeStyle="transparent",e.fillStyle="black",e.fillRect(0,n,t.pianoWidth,o+5);for(let[a,d]of f){const{left:h,width:c}=d;e.fillStyle=ct;const p=i.has(+a)?2:0,g=o+p;if(V(e,h,n,c-r,g,{topRadius:0,bottomRadius:c/10}),O(+a)=="C"){const b=Ce(+a);e.fillStyle="rgb(190,190,190)",e.font=`${c*.65}px ${lt}`;const S=`C${b}`,{width:W}=e.measureText(S);e.textBaseline="bottom",e.fillText(S,h+c/2-W/2-t.whiteNoteSeparation/2,n+o-8)}const m=i.get(+a);m&&(e.fillStyle=m,V(e,h,n,c-r,g,{topRadius:0,bottomRadius:c/10}))}for(let[a,d]of u){let{left:h,width:c,whiteMiddle:p}=d;const g=t.whiteNoteSeparation;e.strokeStyle="transparent",e.fillStyle="black",e.fillRect(h-2,n,c+3,s+2),oe(e,p-t.whiteNoteSeparation-g,n+s+1.5,g+.2,g,c/4),oe(e,p+g,n+s+1.5,-g-.2,g,c/4);const w=i.has(+a);e.fillStyle=i.get(+a)??"black";const m=at();let b=w?m.blackKeyPressed:m.blackKeyRaised,S=w?n:n-2;e.drawImage(b,h,S,c,s),i.has(+a)&&(e.globalCompositeOperation="overlay",e.fillRect(h,S,c,s),e.globalCompositeOperation="source-over",e.globalAlpha=1)}e.restore()}let N=null;function ut(e,t,n){if(!Ee()||Ct()){D(N)&&(L.release(N),N=null);return}const{blackHeight:i,whiteHeight:o}=e;let r=null;for(let[s,l]of Object.entries(e.lanes)){const{left:f,width:u}=l,a=k(+s)?i:o;if(fe(n,{x:f,y:t,height:a,width:u})){r=+s;break}}if(r&&!k(r)&&k(r+1)&&r<108){const{left:s,width:l}=e.lanes[r+1];fe(n,{x:s,y:t,height:i,width:l})&&(r=r+1)}r!=N&&(D(N)&&(L.release(N),N=null),D(r)&&(L.press(r,127/2),N=r))}function fe(e,t){const n=t.x<=e.x&&e.x<=t.x+t.width,i=t.y<=e.y&&e.y<=t.y+t.height;return n&&i}const U="monospace",T={right:{black:Y.purple.dark,white:Y.purple.primary},left:{black:Y.orange.dark,white:Y.orange.primary},measure:"rgb(60,60,60)",octaveLine:"rgb(90,90,90)",rangeSelectionFill:"#44b22e"};function ht(e,t){const n=new Map;for(let i of L.getPressedNotes().keys())n.set(i,"grey");for(let i of t)gt(e,i)&&n.set(i.midiNote,Se(e,i));return n}function gt(e,t){const n=x(t,e),i=t.duration*e.pps,o=n.start-e.height,r=_(o/i,{min:0,max:1});return 0<r&&r<1}function pt(e){return{start:e.time*e.pps+e.height,end:e.time*e.pps}}function mt(e){let t=e.constrictView?e.items:void 0;const n=t?t.filter(h=>h.type==="note"):[{midiNote:21},{midiNote:108}];let i=36;e.windowWidth>e.height&&(e.windowWidth>800?i=88:e.windowWidth>600?i=72:e.windowWidth>500?i=60:e.windowWidth>400?i=40:e.windowWidth>300&&(i=32));const{startNote:o,endNote:r}=Ze({notes:n},i),s=ce(e.windowWidth,{startNote:o,endNote:r}),{whiteHeight:l}=s,f=e.height-l-5,u=l+5,a=Math.max(Math.floor(l/30),6),d=a-2;return B={...e,pianoMeasurements:ce(e.windowWidth,{startNote:o,endNote:r}),viewport:pt(e),pianoTopY:f,greyBarHeight:a,redFeltHeight:d,noteHitY:f-a-d,pianoHeight:u},B}function yt(e){return be(e,i=>x(i,e).end<=e.height,i=>x(i,e).start<0)}function wt(e){const t=mt(e);t.ctx.fillStyle="#2e2e2e",t.ctx.fillRect(0,0,t.windowWidth,t.height);const n=yt(t);Nt(t);for(let i of n)i.type==="measure"&&Pt(i,t);for(let i of n)i.type==="note"&&vt(i,t);t.selectedRange&&St(t),bt(t),kt(t),ut(t.pianoMeasurements,t.pianoTopY,$e(t.canvasRect.left,t.canvasRect.top)),dt(t.ctx,t.pianoMeasurements,t.pianoTopY,ht(t,n.filter(i=>i.type==="note")))}function Se(e,t){const n=e.hands[t.track]?.hand??"both",i=k(t.midiNote)?"black":"white";let o;return n==="both"||n==="right"?o=T.right[i]:o=T.left[i],o}function bt(e){const{ctx:t,windowWidth:n}=e,{pianoTopY:i,redFeltHeight:o}=e,r=i-o;t.save();const s="rgb(159,31,38)";t.fillStyle=s,t.fillRect(0,r,n,o),t.restore()}function St(e){const{ctx:t,windowWidth:n,noteHitY:i,pps:o}=e;if(!e.selectedRange)return;const{start:r,end:s}=e.selectedRange;t.save();const l=s-r,f=0,u=x({type:"note",time:r,duration:l},e).start-(e.height-i),a=l*o;t.fillStyle=T.rangeSelectionFill,t.globalAlpha=.5;const d=Math.floor(n/120),h=Math.floor(d/4);t.fillRect(0,u,n,h),t.fillRect(f,u-a,d,a),t.fillRect(0,u-a-h,n,h),t.restore()}function kt(e){const{pianoTopY:t,redFeltHeight:n,greyBarHeight:i,ctx:o}=e;o.save(),o.fillStyle="rgb(74,74,74)",o.strokeStyle="rgb(40,40,40)";const r=t-n-i;o.fillRect(0,r+.2,e.windowWidth,i),o.strokeRect(0,r,e.windowWidth,i),o.restore()}function Nt(e){const{ctx:t}=e;t.save(),t.lineWidth=2;for(let[n,{left:i}]of Object.entries(e.pianoMeasurements.lanes)){const o=O(+n);o==="C"&&(t.strokeStyle=T.octaveLine,j(t,i-2,0,i,e.height)),o==="F"&&(t.strokeStyle=T.measure,j(t,i-2,0,i,e.height))}t.restore()}function vt(e,t){if(!(e.midiNote in t.pianoMeasurements.lanes))return;const{ctx:n,pps:i,noteLabels:o}=t,r=t.pianoMeasurements.lanes[e.midiNote],s=x(e,t).end-(t.height-t.noteHitY),l=Math.floor(r.left+1),f=r.width-2,u=Se(t,e),a=e.duration*i,d=rt(n,"",f*2/3).height+15,h=Math.floor(Math.max(a,d));if(n.save(),n.fillStyle=u,n.strokeStyle="rgb(40,40,40)",V(n,l,s,f,h),o!=="none"){n.fillStyle="white",n.strokeStyle="black",n.textBaseline="bottom";const c=O(e.midiNote,t.keySignature),p=o==="alphabetical"?c:ee(c),w=f-1*2,{fontPx:m,measuredWidth:b}=ot(n,p,U,w);n.font=`${m}px ${U}`,n.fillText(p,l+f/2-b/2,s+h-4)}n.restore()}function Pt(e,t){const{ctx:n,windowWidth:i}=t;n.save();const o=x(e,t).start-(t.height-t.noteHitY);n.strokeStyle=n.fillStyle=T.measure,n.lineWidth=2,j(n,0,o,i,o),n.strokeStyle="rgb(130,130,130)",n.fillStyle="rgb(130,130,130)",n.font=`16px ${U}`,n.fillText(e.number.toString(),i/100,Math.floor(o-5)),n.restore()}function x(e,t){const n=t.viewport.start-e.time*t.pps,i=e.type==="note"?e.duration:100,o=n-i*t.pps;return{start:n,end:o}}let B=null;function Rt(e){return B?e>=B.pianoTopY:!1}let F=!1;function Ct(){return F}function ke(e,t){const n=_(t+e.getTime(),{min:0,max:e.getDuration()});e.seek(n)}const Lt=.96;let M=0;function Ne(e){F=!1,requestAnimationFrame(()=>{const t=M/te,n=1/60*e.store.get(e.getBpmModifier());Math.abs(t)>n?(ke(e,t),M*=Lt,Ne(e)):Mt(e)})}let q=!1;function Tt(e,t){if(Rt(t.clientY)){F=!1;return}F=!0,t.target.setPointerCapture(t.pointerId),e.isPlaying()&&(q=!0,e.pause()),M=0}function xt(e,t){t.target.releasePointerCapture(t.pointerId),Ne(e)}function Mt(e){q&&(q=!1,e.play()),M=0}function Wt(e,t){if(!F)return;const n=Ye().y;ke(e,n/te),Math.abs(n)>5?M=n:M=0}const ve="Arial",v=100,H=80,de=y;function It(e){return{start:e.time*e.pps,end:e.time*e.pps+(e.windowWidth-v)}}function Ft(e){return{...e,viewport:It(e)}}function Ht(e){const t=Ft(e);t.ctx.clearRect(0,0,t.windowWidth,t.height),$t(t);const n=Ot(t);for(const i of n)i.type!=="measure"&&Bt(t,i);for(const i of n)i.type!=="measure"&&At(t,i);Et(t),Kt(t,n)}function Ot(e){return be(e,i=>A(e,i).end>=0,i=>A(e,i).start>e.windowWidth)}function Et(e){const{ctx:t,keySignature:n}=e,i=P(e)-y*2;t.clearRect(0,0,i,e.height),t.fillStyle="black",t.strokeStyle="black";const o=H*2+100,r=e.height/2+o/2;Xe(e.ctx,v-25,r,o);const s=H,l=E(e),f=$(e);X(e.ctx,v,l,i),X(e.ctx,v,f,i),Be(e.ctx,v,l-1,f+s+1);const u=l-de,a=f+s+de;if(Ae(t,P(e)-2,u,a),De(t,Z(),l),Ke(t,Z(),f),re(t,J(),l,n,"treble"),re(t,J(),f,n,"bass"),e.timeSignature){const d=Pe(e);se(t,d,l,e.timeSignature),se(t,d,f,e.timeSignature)}}function $t(e){const{ctx:t}=e;t.fillStyle="black",t.strokeStyle="black";const n=E(e),i=$(e);X(e.ctx,v,n,e.windowWidth),X(e.ctx,v,i,e.windowWidth)}function E(e){const t=H;return e.height/2-50-t}function $(e){return e.height/2+50}function Z(){return v+y}function J(){return Z()+3*y}function Pe(e){const t=xe(e.keySignature).notes.length;return J()+t*y+y}function P(e){return Pe(e)+y*4}const C={primary:"121,74,227",hover:"185,154,244",disabled:"100,100,100",black:"0,0,0"},Yt={A:"12,23,141",B:"75,32,139",C:"217,59,38",D:"238,151,56",E:"253,229,65",F:"62,139,38",G:"139,210,250"};function _t(e,t,n){const i=P(e),o=n<=i;return ge(e.player,t)&&L.getPressedNotes().has(t.midiNote)?C.hover:Te(e.player,t)?C.disabled:o?C.primary:C.black}function Xt(e,t,n,i,o){const r=P(e);return n<=r?C.primary:Q(i,o)}function Bt(e,t){const{ctx:n,pps:i,keySignature:o}=e,r=A(e,t).start,s=e.hands?.[t.track].hand==="right"?"treble":"bass",l=s==="treble"?E(e):$(e),f=P(e);let u=r+f+we/2;const a=n.createLinearGradient(f-y*2,0,f,0);Re("0,0,0",a),n.fillStyle=a,n.strokeStyle=a,_e(n,u-y,y*2,l,t.midiNote,s,e.keySignature)}function At(e,t){const{ctx:n,pps:i,keySignature:o}=e;n.save();const r=Math.round(i*t.duration),s=A(e,t).start;Dt(s,r);const l=e.hands?.[t.track].hand==="right"?"treble":"bass",f=l==="treble"?E(e):$(e),u=P(e);let a=s+u+we/2,d=pe(t.midiNote,l,f,o);const h=O(t.midiNote,e.keySignature),c=e.game?_t(e,t,a):Xt(e,t,a,e.coloredNotes,h[0]),p=r-y,g=10,w=n.createLinearGradient(u-y*2,0,u,0);if(Re(c,w),n.fillStyle=w,n.strokeStyle=w,n.fillRect(a+y/2,d-g/2,p,g),n.globalCompositeOperation="source-over",a<u-y*2){n.restore();return}me(n,a,d,w);const m=h.length==2&&h[1];if(m){const b=m==="#"?z.accidentalSharp:z.accidentalFlat,S=a-(y+8);ye(n,b,S,d,H*.8,w)}if(e.noteLabels!=="none"){n.font=`9px ${ve}`,n.fillStyle="white";const b=h[0],S=e.noteLabels==="alphabetical"?b:ee(b),W=e.noteLabels==="alphabetical"?0:3;n.fillText(S,a-W,d+3)}n.restore()}function A(e,t){const n=t.time*e.pps-e.viewport.start,i=t.type==="note"?t.duration:100,o=n+i*e.pps;return{start:n,end:o}}function Dt(e,t){const n="#000000";if(e+t<0||e>=0)return n;const i=Math.max((e+t)/t,.15);return Le("#8147EB",n,i)}function Kt(e,t){const{ctx:n}=e,i=L.getPressedNotes();for(let o of i.keys()){let r=o<Me("C4")?"bass":"treble";const s=t.find(d=>d.type==="note"&&d.midiNote===+o);if(s&&(r=e.hands?.[s.track].hand==="right"?"treble":"bass"),e.game&&ge(e.player,s))return;const l=r==="bass"?$(e):E(e),f=pe(o,r,l);let u=P(e)-2;const a=O(o);if(me(n,u,f,e.coloredNotes?`rgba(${Q(!0,a[0])},1)`:"red"),a.length===2){const d=e.coloredNotes?`rgba(${Q(!0,a[0])},1)`:"black";ye(n,z.accidentalSharp,u-24,f,H*.6,d)}if(e.noteLabels!=="none"){n.font=`9px ${ve}`,n.fillStyle="white";const d=a[0],h=e.noteLabels==="alphabetical"?d:ee(d);n.fillText(h,u,f+3)}}}function Re(e,t){t.addColorStop(0,`rgba(${e},0)`),t.addColorStop(.5,`rgba(${e},0.1)`),t.addColorStop(.8,`rgba(${e},0.3`),t.addColorStop(1,`rgba(${e},1)`)}function Q(e,t){return e?Yt[t]:C.black}function Vt(e){e.visualization==="falling-notes"?wt(e):Ht(e)}function nn({song:e,config:t,hand:n,handSettings:i,selectedRange:o,getTime:r,constrictView:s=!0,enableTouchscroll:l=!1,game:f=!1}){const u=R.useRef(!1),{width:a,height:d,measureRef:h}=He(),c=R.useRef(null),p=We();R.useEffect(()=>{st().then(()=>u.current=!0)});const g=R.useMemo(()=>c.current?.getBoundingClientRect()??{},[a,d]);function w(m,{width:b,height:S}){if(!e||!u.current)return;const W={time:r(),visualization:t.visualization,noteLabels:t.noteLabels,coloredNotes:t.coloredNotes,windowWidth:b,height:S,pps:te,hands:i,hand:n,ctx:m,items:e.items,constrictView:!!s,keySignature:t.keySignature??e.keySignature,timeSignature:e.timeSignature,canvasRect:g,selectedRange:o,game:f,player:p};Vt(W)}return ne.jsx("div",{className:"absolute h-full w-full touch-none",ref:h,onPointerMove:m=>l&&Wt(p,m.nativeEvent),onPointerDown:m=>l&&Tt(p,m.nativeEvent),onPointerUp:m=>l&&xt(p,m.nativeEvent),children:ne.jsx(Oe,{ref:c,render:w})})}export{nn as C,Zt as P,Jt as a,tn as b,en as c,Qe as g,Qt as u};
