import{p as e,a as h,w as ee,t as se,v as te}from"./chunk-PVWAREVJ-BeAWct5i.js";import{C as A,A as ne,R as ae}from"./AdjustInstruments-2T0166Fg.js";import{S as ie}from"./SongScrubBar-Bi4bL6LF.js";import{u as L,j,r as $,k as F,c as P,l as oe,a as le,m as W}from"./context-kPolJz0x.js";import{a as re,u as q}from"./Dropdown-B9h-t97s.js";import{g as ce,u as de,b as xe,C as me,c as he}from"./SongVisualizer-BApS7ggG.js";import{u as ue,a as fe}from"./index-DcBgwC9u.js";import{u as ge}from"./useLazyStableRef-B5HeSgmi.js";import{u as pe,T as k}from"./Toggle-vxrgibW8.js";import{s as je,r as Ne}from"./Canvas-C5qiJpk2.js";import{C as D,u as we}from"./useWakeLock-DSwNU-kK.js";import{u as be,C as K}from"./library--ia92sxe.js";import{S as ve,C as ye,T as Se,a as Ce,A as X}from"./TopBar-7xEZzvoF.js";import"./common-wRUDMAM3.js";import"./manifest-DPsq83CE.js";import"./index-Zv5TxpGm.js";import"./index-5h7t3GzQ.js";function ke(s){return pe(`${s}/settings`,ce())}function Me(){const s=L(),r=j(s.getBpm()),x=j(s.getBpmModifier()),a=$(r)+" BPM",i=$(x*100)+"%",m=24;return e.jsxs("div",{className:"mx-auto flex gap-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"self-center text-center text-xl",children:i}),e.jsx("span",{className:"text-center text-sm",children:a})]}),e.jsxs("div",{className:"flex flex-col justify-between",children:[e.jsx(D,{size:m,className:"hover:text-purple-hover text-black hover:cursor-pointer",onClick:s.increaseBpm.bind(s)}),e.jsx(A,{size:m,className:"hover:text-purple-hover text-black hover:cursor-pointer",onClick:s.decreaseBpm.bind(s)})]})]})}const E=[.25,.5,1,2,4],Pe=s=>s<1?`1/${1/s}×`:`${s}×`,G=24;function Re(){const s=L(),[r,x]=F(s.metronomeEmphasizeFirst),[a,i]=F(s.metronomeSpeed),[m,t]=F(s.metronomeVolume),o=E.findIndex(g=>g===a),f=m===0;return e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex w-full items-center",children:[e.jsx("span",{className:"mr-4 whitespace-nowrap text-gray-700",children:"Volume"}),e.jsx("div",{className:"flex-1",children:e.jsx(ve,{orientation:"horizontal",min:0,max:1,step:.01,value:[m],onValueChange:g=>t(g[0]),onClick:g=>g.stopPropagation(),className:"h-2 w-full"})})]}),e.jsxs("div",{className:P("flex w-full items-center justify-between",f&&"pointer-events-none opacity-50"),children:[e.jsx("span",{children:"Speed"}),e.jsxs("div",{className:"flex flex-col items-center justify-between",children:[e.jsx(D,{size:G,className:"hover:text-purple-hover cursor-pointer text-black",onClick:()=>i(E[Math.min(o+1,E.length-1)])}),e.jsx("span",{className:"text-sm",children:Pe(a)}),e.jsx(A,{size:G,className:"hover:text-purple-hover cursor-pointer text-black",onClick:()=>i(E[Math.max(o-1,0)])})]})]}),e.jsxs("div",{className:P("flex w-full items-center justify-between",f&&"pointer-events-none opacity-50"),children:[e.jsx("span",{children:"Emphasize 1st Beat"}),e.jsx(k,{checked:r,onChange:x})]})]})}function Ee(s){const{left:r,right:x,visualization:a,waiting:i,noteLabels:m,coloredNotes:t,keySignature:o}=s.config,{onClose:f,onLoopToggled:g,isLooping:y}=s,[w,S]=h.useState(!1),l=h.useRef(null),c=h.useCallback(()=>f?.(),[f]);re(c,l),q("keydown",n=>{n.key==="Escape"&&f?.()});const u=n=>{n==="left"&&s.onChange({...s.config,left:!s.config.left}),n==="right"&&s.onChange({...s.config,right:!s.config.right})},N=n=>{s.onChange({...s.config,visualization:n})};function z(n){s.onChange({...s.config,waiting:n})}function T(n){s.onChange({...s.config,noteLabels:n})}function R(){s.onChange({...s.config,coloredNotes:!t})}function b(n){s.onChange({...s.config,keySignature:n})}return e.jsxs("div",{className:"relative flex max-h-[calc(100vh-300px)] w-full flex-col gap-4 overflow-auto bg-gray-100 p-4 sm:flex-row",ref:l,children:[e.jsx("h3",{className:"text-purple-primary text-center text-2xl",children:"Settings"}),e.jsxs("div",{className:"mx-20 flex grow flex-col flex-wrap items-stretch gap-4 whitespace-nowrap sm:mx-0 sm:flex-row",children:[e.jsx(v,{title:"Speed",className:"flex grow",children:e.jsx(Me,{})}),e.jsx(v,{title:"Metronome",className:"flex grow flex-col",children:e.jsx(Re,{})}),e.jsxs(v,{title:"Hands",className:"flex grow flex-col",children:[e.jsxs("div",{className:"flex justify-center gap-2",children:[e.jsx("span",{className:"w-10",children:"Left"}),e.jsx(k,{className:"self-center",checked:r,onChange:()=>u("left")})]}),e.jsxs("div",{className:"flex justify-center gap-2",children:[e.jsx("span",{className:"w-10",children:"Right"}),e.jsx(k,{checked:x,onChange:()=>u("right")})]})]}),e.jsxs(v,{title:"Visualization",className:"grow",children:[e.jsxs("button",{className:"flex items-center justify-center gap-1",onClick:()=>N("falling-notes"),children:[e.jsx("input",{type:"radio",className:"w-5",checked:a==="falling-notes",readOnly:!0}),e.jsx("span",{className:"block w-[120px] text-left",children:"Falling notes"})]}),e.jsxs("button",{className:"flex items-center justify-center gap-1",onClick:()=>N("sheet"),children:[e.jsx("input",{className:"w-5",type:"radio",checked:a==="sheet",readOnly:!0}),e.jsx("span",{className:"block w-[120px] text-left",children:" Sheet hero (beta)"})]})]}),e.jsxs("div",{className:"flex grow flex-col gap-4 sm:flex-row",children:[e.jsxs(v,{title:"Additional settings",className:"grow justify-center",children:[e.jsxs("div",{className:"flex justify-center",children:[e.jsx("span",{className:"min-w-[18ch]",children:"Wait mode"}),e.jsx("div",{className:"flex w-[120px]",children:e.jsx(k,{checked:i,onChange:z})})]}),e.jsxs("div",{className:"flex justify-center",children:[e.jsx("span",{className:"min-w-[18ch]",children:"Colored notes"}),e.jsx("div",{className:"flex w-[120px]",children:e.jsx(k,{checked:t,onChange:R})})]}),e.jsxs("div",{className:"flex justify-center",children:[e.jsx("span",{className:"min-w-[18ch]",children:"Note Labels"}),e.jsxs("select",{name:"noteLabels",className:"w-[120px] border bg-white",value:m,onChange:n=>T(n.target.value),children:[e.jsx("option",{value:"none",children:"None"},"id-none"),e.jsx("option",{value:"alphabetical",children:"Alphabetical"},"id-alphabetical"),e.jsx("option",{value:"fixed-do",children:"Fixed-Do"},"id-fixed-do")]})]}),e.jsxs("div",{className:"flex justify-center",children:[e.jsx("span",{className:"min-w-[18ch]",children:"Key signature"}),e.jsx("div",{className:"flex w-[120px]",children:e.jsx("select",{name:"keySignature",className:"w-[50px] border bg-white",value:o??s.song?.keySignature,onChange:n=>b(n.target.value),children:oe().map(n=>e.jsx("option",{value:n,children:n},`id-${n}`))})})]})]}),e.jsxs("div",{className:"flex grow flex-col justify-between gap-4",children:[e.jsx(v,{title:"Practice loop",children:e.jsx("div",{className:"flex justify-center",children:e.jsx(k,{checked:y,onChange:g})})}),e.jsx(v,{title:"Track configuration",onClick:()=>S(n=>!n),className:"hover:bg-purple-light cursor-pointer"})]})]}),w&&e.jsx("div",{className:"flex max-w-[70vw] basis-full flex-wrap justify-center",children:e.jsx(ne,{config:s.config,setTracks:n=>{s.onChange({...s.config,tracks:n})},song:s.song})})]})]})}function v({children:s,title:r,className:x,onClick:a}){return e.jsxs("article",{className:P(x,"flex flex-col gap-4 rounded-md bg-gray-200 px-8 py-4 sm:min-w-0"),onClick:a,children:[e.jsx("h3",{className:"text-center text-base font-semibold",children:r}),s]})}function U(s,r,x,a){const i=r==="x"?window.innerWidth:window.innerHeight,m=r==="x"?x:a,t=typeof s=="number"?s:i*(parseFloat(s)/100)-m;return Math.max(0,Math.min(t,i-m))}function Le({initialPosition:s={x:0,y:0},header:r,children:x}){const[a,i]=h.useState(!1),[m,t]=h.useState({x:0,y:0}),o=h.useRef(null),f=h.useRef(!1),g=h.useRef({x:0,y:0});h.useEffect(()=>{if(!o.current)return;const l=o.current.offsetWidth,c=o.current.offsetHeight;t({x:U(s.x,"x",l,c),y:U(s.y,"y",l,c)})},[]),h.useEffect(()=>{function l(){if(!o.current)return;const c=o.current.offsetWidth,u=o.current.offsetHeight;t(N=>({x:Math.max(0,Math.min(N.x,window.innerWidth-c)),y:Math.max(0,Math.min(N.y,window.innerHeight-u))}))}return window.addEventListener("resize",l),()=>window.removeEventListener("resize",l)},[]);const y=l=>{if(!o.current)return;f.current=!0;const c=o.current.getBoundingClientRect();g.current={x:l.clientX-c.left,y:l.clientY-c.top},document.addEventListener("mousemove",w),document.addEventListener("mouseup",S)},w=l=>{if(!f.current||!o.current)return;const c=o.current,u=Math.max(0,Math.min(l.clientX-g.current.x,window.innerWidth-c.offsetWidth)),N=Math.max(0,Math.min(l.clientY-g.current.y,window.innerHeight-c.offsetHeight));c.style.transform=`translate(${u}px, ${N}px)`},S=()=>{if(!f.current||!o.current)return;f.current=!1;const l=o.current.getBoundingClientRect();t({x:l.left,y:l.top}),document.removeEventListener("mousemove",w),document.removeEventListener("mouseup",S)};return e.jsx("div",{ref:o,className:"fixed z-50 w-[290px] cursor-grab rounded-xl bg-black/80 text-white shadow-2xl select-none",style:{transform:`translate(${m.x}px, ${m.y}px)`},onMouseDown:y,children:e.jsxs("div",{className:"relative flex w-full flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex h-[40px] w-full cursor-grab items-center justify-between px-3",children:[r,e.jsx("button",{className:"ml-2 hover:opacity-70",onClick:l=>{l.stopPropagation(),i(c=>!c)},children:a?e.jsx(D,{}):e.jsx(A,{})})]}),e.jsx("div",{className:"overflow-hidden transition-[max-height] duration-300",style:{maxHeight:a?200:0},children:e.jsx("div",{className:"p-4 text-sm",children:x})})]})})}function ze({}){const s=L(),r=j(s.score.accuracy),x=j(s.score.streak),a=j(s.score.perfect),i=j(s.score.good),m=j(s.score.missed),t=j(s.score.error);return e.jsx(Le,{initialPosition:{x:"100%",y:90},header:e.jsxs("div",{className:"flex h-[40px] w-full cursor-grab items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ye,{className:"h-5 w-5 text-white"}),e.jsx("span",{className:"font-semibold text-white",children:"Session Stats"})]}),e.jsxs("span",{className:"ml-auto w-16 text-right font-semibold text-white",children:[r,"%"]})]}),children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex items-center justify-center rounded-lg bg-slate-500/40 px-4 py-2",children:[e.jsx("span",{className:"mr-2 text-sm font-bold text-white",children:"STREAK"}),e.jsx("span",{className:"text-2xl font-bold text-white",children:x})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-3",children:[e.jsxs("div",{className:"flex flex-col items-center rounded-lg bg-black/40 px-4 py-3",children:[e.jsx("span",{className:"text-sm font-bold text-green-400",children:"PERFECT"}),e.jsx("span",{className:"text-2xl font-bold text-green-400",children:a})]}),e.jsxs("div",{className:"flex flex-col items-center rounded-lg bg-black/40 px-4 py-3",children:[e.jsx("span",{className:"text-sm font-bold text-blue-400",children:"GOOD"}),e.jsx("span",{className:"text-2xl font-bold text-blue-400",children:i})]}),e.jsxs("div",{className:"flex flex-col items-center rounded-lg bg-black/40 px-4 py-3",children:[e.jsx("span",{className:"text-sm font-bold text-red-400",children:"MISSED"}),e.jsx("span",{className:"text-2xl font-bold text-red-400",children:m})]}),e.jsxs("div",{className:"flex flex-col items-center rounded-lg bg-black/40 px-4 py-3",children:[e.jsx("span",{className:"text-sm font-bold text-yellow-400",children:"ERROR"}),e.jsx("span",{className:"text-2xl font-bold text-yellow-400",children:t})]})]})]})})}function Te({onGrantPermission:s,onGoBack:r}){return e.jsx("div",{className:"flex h-screen items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"mx-auto max-w-md rounded-lg bg-white p-6 shadow-lg",children:[e.jsxs("div",{className:"mb-4 flex items-center gap-3",children:[e.jsx(K,{className:"h-6 w-6 text-orange-500"}),e.jsx("h2",{className:"text-lg font-medium text-gray-900",children:"Permission Required"})]}),e.jsx("p",{className:"mb-6 text-sm text-gray-600",children:"We need permission to access your music files. Please grant access to continue playing this song."}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:r,className:"flex items-center gap-2 rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50",children:[e.jsx(X,{className:"h-4 w-4"}),"Go Back"]}),e.jsxs("button",{onClick:s,className:"flex items-center gap-2 rounded-md bg-black px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-gray-800",children:[e.jsx(ae,{className:"h-4 w-4"}),"Grant Permission"]})]})]})})}function Be({songTitle:s,onGoBack:r}){return e.jsx("div",{className:"flex h-screen items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"mx-auto max-w-md rounded-lg bg-white p-6 text-center shadow-lg",children:[e.jsx("div",{className:"mb-4",children:e.jsx(K,{className:"mx-auto h-12 w-12 text-red-500"})}),e.jsx("h2",{className:"mb-2 text-lg font-medium text-gray-900",children:"Song Not Found"}),s&&e.jsxs("p",{className:"mb-4 text-sm text-gray-600",children:['Could not load "',s,'". The file may have been moved or deleted.']}),e.jsx("p",{className:"mb-6 text-sm text-gray-500",children:`Please check that the file still exists or try selecting a different song. It may also be that Sightread lost access to your local files. If that's the case, please re-scan directories in the "Manage Folders" menu.`}),e.jsxs("button",{onClick:r,className:"mx-auto flex cursor-pointer items-center gap-2 rounded-md bg-black px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-gray-800",children:[e.jsx(X,{className:"h-4 w-4"}),"Go Back to Song List"]})]})})}const Qe=ee(function(){const[r]=se(),x=te();let{source:a,id:i,recording:m}=Object.fromEntries(r);if(!a||!i)return x("/",{replace:!0}),null;i=decodeURIComponent(i);const t=L(),[o,f]=h.useState(!1),[g,y]=h.useState(!1),[w,S]=h.useState(!0),l=ue(),c=ge(()=>le("acoustic_grand_piano"));let{data:u,error:N,isLoading:z,mutate:T}=fe(i,a),R=be(i,a);const b=j(t.getRange()),n=h.useMemo(()=>b?{start:b[0],end:b[1]}:void 0,[b]),Y=!!b,_=j(Ne),[p,B]=ke(i),J=!!m;we();const Q=p.left&&p.right?"both":p.left?"left":p.right?"right":"none",{waiting:O,left:H,right:I}=p;h.useEffect(()=>{t.setWait(O),H&&I?t.setHand("both"):t.setHand(H?"left":"right")},[O,H,I,t]),de(()=>t.stop()),h.useEffect(()=>{if(!u)return;const d=xe(i,u);B(d),t.setSong(u,d)},[u,B,i,t]),q("keydown",d=>{d.code==="Space"?(d.preventDefault(),t.toggle()):d.code==="Comma"?t.seek(t.currentSongTime-16/1e3):d.code==="Period"&&t.seek(t.currentSongTime+16/1e3)}),h.useEffect(()=>{const d=({type:C,note:M,velocity:V})=>{C==="down"?c.playNote(M,V):c.stopNote(M,V)};return W.subscribe(d),function(){W.unsubscribe(d)}},[c,u,p]);const Z=d=>{if(d){const C=t.getDuration(),M=C/10;t.setRange({start:C/2-M,end:C/2+M})}else{t.setRange(void 0);return}};return a==="local"&&_?e.jsx(Te,{onGrantPermission:async()=>{await je(),T()},onGoBack:()=>{t.stop(),x("/songs")}}):N||a==="local"&&!u&&!z?e.jsx(Be,{songTitle:R?.title,onGoBack:()=>{t.stop(),x("/songs")}}):e.jsxs(e.Fragment,{children:[e.jsx("title",{children:"Playing"}),e.jsxs("div",{className:P("fixed","flex h-screen max-h-screen max-w-screen flex-col outline-none"),...W.getListenerProps(),autoFocus:!0,children:[!J&&e.jsxs(e.Fragment,{children:[e.jsx(Se,{title:R?.title,isLoading:!l.canPlay,isPlaying:l.playing,onTogglePlaying:()=>t.toggle(),onClickRestart:()=>t.restart(),onClickBack:()=>{t.stop(),x("/")},onClickMidi:d=>{d.stopPropagation(),y(!g)},onClickSettings:d=>{d.stopPropagation(),f(!o)},onClickStats:d=>{S(!w)},settingsOpen:o,statsVisible:w}),e.jsx(Ce,{isOpen:g,onClose:()=>y(!1)}),o&&e.jsx(Ee,{onClose:()=>f(!1),onChange:B,config:p,song:u,onLoopToggled:Z,isLooping:Y}),e.jsx("div",{className:"relative min-w-full",children:e.jsx(ie,{rangeSelection:n,setRange:d=>t.setRange(d),height:40})}),w&&e.jsx(ze,{})]}),e.jsx("div",{className:P("fixed -z-10 h-[100vh] w-screen","h-[100dvh]!",p.visualization==="sheet"?"bg-white":"bg-[#2e2e2e]"),children:e.jsx(me,{song:u,config:p,hand:Q,handSettings:he(p),selectedRange:n,getTime:()=>t.getTime(),enableTouchscroll:p.visualization==="falling-notes"})})]})]})});export{Qe as default};
