import{R as D,a as f,p as T}from"./chunk-PVWAREVJ-BeAWct5i.js";import{i as M,a1 as K,s as S,S as Y}from"./context-kPolJz0x.js";function Q(t){const e=D.useRef(null),r=D.useRef(null),n=f.useCallback(s=>{if(r.current!==void 0){const o=s-r.current;t(o)}r.current=s,e.current=requestAnimationFrame(n)},[t]);f.useEffect(()=>(e.current=requestAnimationFrame(n),()=>cancelAnimationFrame(e.current)),[n])}let k,m;function X(){return k||(m=new WeakMap,k=new ResizeObserver(t=>{const e=new Set;for(let r=t.length-1;r>=0;r--){const{target:n,contentRect:s}=t[r];e.has(n)||(e.add(n),m.get(n)?.forEach(o=>o({width:s.width,height:s.height})))}})),k}function Z(t,e){const r=X();return m.has(t)||m.set(t,[]),m.get(t).push(e),r.observe(t),()=>{ee(m.get(t),e),m.get(t)?.length==0&&(r.unobserve(t),m.delete(t))}}function ee(t,e){var r=t?.indexOf(e);r>-1&&t.splice(r,1)}function te(){const[t,e]=f.useState(null),r=f.useRef(null),n=f.useRef(!0),s=f.useCallback(l=>{if(!l){r.current?.(),r.current=null;return}const u=l.getBoundingClientRect();e({width:u.width,height:u.height}),r.current=Z(l,i=>{n.current&&e(i)})},[]);f.useEffect(()=>(n.current=!0,()=>{n.current=!1}),[]);let o=t?.width??0,a=t?.height??0;return{width:o,height:a,measureRef:s}}class y{static cache=new Map;static set(e,r){if(M()){this.cache.set(e,r);try{localStorage.setItem(e,JSON.stringify(r))}catch(n){console.error(n)}}}static has(e){return y.get(e),this.cache.get(e)!=null}static get(e){if(!M()||e===null)return null;if(this.cache.has(e))return this.cache.get(e);let r=null;try{r=JSON.parse(localStorage.getItem(e)??"null")}catch{}return this.cache.set(e,r),r}static delete(e){this.cache.delete(e);try{localStorage.removeItem(e)}catch(r){console.error(r)}}}function A(t){return new Promise((e,r)=>{t.oncomplete=t.onsuccess=()=>e(t.result),t.onabort=t.onerror=()=>r(t.error)})}function re(t,e){let r;const n=()=>{if(r)return r;const s=indexedDB.open(t);return s.onupgradeneeded=()=>s.result.createObjectStore(e),r=A(s),r.then(o=>{o.onclose=()=>r=void 0},()=>{}),r};return(s,o)=>n().then(a=>o(a.transaction(e,s).objectStore(e)))}let b;function F(){return b||(b=re("keyval-store","keyval")),b}function ne(t,e=F()){return e("readonly",r=>A(r.get(t)))}function L(t,e,r=F()){return r("readwrite",n=>(n.put(e,t),A(n.transaction)))}function R(t){return t.sort((e,r)=>e.time-r.time)}function se(t){const e=new K.Midi(t),r=e.header.tempos.map(i=>({time:e.header.ticksToSeconds(i.ticks),bpm:i.bpm}));let n=e.tracks.flatMap((i,d)=>i.notes.map(h=>({type:"note",midiNote:h.midi,track:d,time:h.time,duration:h.duration,velocity:h.velocity*127,measure:Math.floor(e.header.ticksToMeasures(h.ticks))})));const s=Object.fromEntries(e.tracks.map((i,d)=>[d,{name:i.name,instrument:i.channel===9?"percussion":i.instrument.name,program:i.instrument.number}])),o=e.header.timeSignatures[0]?.timeSignature??[4,4],a=e.header.keySignatures[0]?.key;let l=1;const u=e.header.timeSignatures.flatMap((i,d,h)=>{let w=i.ticks,q=h[d+1]?h[d+1].ticks:e.durationTicks,I=i.timeSignature[0]/i.timeSignature[1]*(4*e.header.ppq),B=e.header.ticksToMeasures(w),G=e.header.ticksToMeasures(q),_=Math.ceil(G-B),N=e.header.ticksToSeconds(w+I)-e.header.ticksToSeconds(w);const W="measure",H=N;return Array.from({length:_}).map((he,U)=>{let $=l++;const V=w+U*I,J=e.header.ticksToSeconds(V);return{type:W,number:$,duration:H,time:J}})});return{duration:e.duration,measures:R(u),notes:R(n),tracks:s,bpms:r,timeSignature:{numerator:o[0],denominator:o[1]},keySignature:a,items:R([...u,...n]),ppq:e.header.ppq,secondsToTicks:i=>e.header.secondsToTicks(i),ticksToSeconds:i=>e.header.ticksToSeconds(i)}}const E="OBSERVED_DIRECTORIES",ie=["SONG_DATA","UPLOADS/SONG_LIST"];if(globalThis.localStorage?.length>0)for(const t of ie)localStorage.removeItem(t);const g=S([]),P=S(!1),j=S(new Map),C=S(!1),c=Y();async function x(){if(c.get(C))return Promise.resolve();try{const t=await ne(E)??[];if(c.set(g,t),!(await Promise.all(t.map(r=>oe(r.handle)))).every(r=>r)){c.set(P,!0);return}await O()}catch(t){console.error("persistence init failed",t)}finally{c.set(C,!0)}}async function oe(t){return await t.queryPermission({mode:"read"})==="granted"}function ae(){return"showDirectoryPicker"in window}async function pe(){if(!ae())throw new Error("File System Access API is not supported in this browser");await x();try{const t=await window.showDirectoryPicker({mode:"read",startIn:"music"}),e=c.get(g);(await Promise.all(e.map(n=>n.handle.isSameEntry(t)))).find(n=>n)||(e.push({id:crypto.randomUUID(),handle:t,addedAt:Date.now()}),c.set(g,e),await L(E,e),await O());return}catch(t){if(t.name==="AbortError")return;throw t}}const v=S(!1);async function O(){const t=c.get(v);if(t!==!1){await t;return}const{resolve:e,reject:r,promise:n}=Promise.withResolvers();c.set(v,n);try{let s=new Map;const o=c.get(g);if(c.get(P)){for(const a of o)if(!(await a.handle.requestPermission({mode:"read"})==="granted")){console.warn("Permission not granted for",a.handle.name);return}c.set(P,!1)}for(const a of o){const l=await ue(a);s.set(a.id,l)}c.set(j,s),e(void 0)}catch(s){r(new Error("Error scanning folders:",{cause:s}))}finally{c.set(v,!1)}}function ce(t){return t.type==="audio/midi"||t.type==="audio/mid"||t.name.endsWith(".mid")||t.name.endsWith(".midi")}async function Se(t){await x();const[e,r]=t.split("/"),n=c.get(g).find(a=>a.id===e);if(!n){console.error("Missing expected directory handle");return}return c.get(j).get(n?.id)?.find(a=>a.handle?.name===r)?.handle}x();async function ue(t){const e=[];try{for await(const[r,n]of t.handle.entries())if(n.kind==="file"){const s=n,o=await s.getFile();try{if(ce(o)){const a=r,l=a;let u=await o.arrayBuffer(),i=new Uint8Array(u),d=se(i).duration;const h={id:t.id+"/"+r,title:a,file:l,source:"local",difficulty:0,duration:d,handle:s};e.push(h)}}catch(a){console.error(`Error parsing MIDI file ${r}:`,a)}}}catch(r){throw console.error("Error scanning folder:",r),new Error(`Failed to scan folder: ${r.message}`)}return e}function we(t){const e=c.get(g).filter(r=>r.id!==t);c.set(g,e),L(E,e),O()}function ye(t){return y.get(`${t}/settings`)}function ke(t,e){return y.set(`${t}/settings`,e)}let p=null;function z(){return M()&&navigator.wakeLock}async function le(){if(z())try{p=await Promise.resolve(navigator?.wakeLock.request())}catch(t){console.error(t)}}function be(){p&&(p?.release(),p=null)}function de(){p!==null&&document.visibilityState==="visible"&&le()}z()&&document.addEventListener("visibilitychange",de);function Re({height:t,width:e}){return T.jsx("div",{style:{width:e,height:t,minWidth:e,minHeight:t}})}const fe=f.forwardRef(({render:t},e)=>{const{width:r,height:n,measureRef:s}=te(),o=f.useRef(null),a=f.useRef(null);a.current=t;const l=f.useCallback(u=>{if(!u)return;u.style.width=r+"px",u.style.height=n+"px",e&&(typeof e=="function"?e(u):"current"in e&&(e.current=u));const i=window.devicePixelRatio??1;u.width=Math.round(r*i),u.height=Math.round(n*i);const d=u.getContext("2d");d.scale(i,i),o.current=d},[r,n,e]);return Q(()=>{o.current&&a.current?.(o.current,{width:r,height:n})}),T.jsx("div",{className:"relative h-full w-full",ref:s,children:T.jsx("canvas",{ref:l,width:r,height:n})})});fe.displayName="Canvas";export{fe as C,y as L,Re as S,pe as a,we as b,v as c,j as d,Q as e,x as f,Se as g,le as h,ae as i,be as j,ye as k,g as l,ke as m,se as p,P as r,O as s,te as u};
