import{a as d,p as e,L as S,w as N}from"./chunk-PVWAREVJ-BeAWct5i.js";import{g as k,a as M,u as C,b as T,f as v,d as P,i as E,e as R,m as u,h as B}from"./context-kPolJz0x.js";import{C as L}from"./SongVisualizer-BApS7ggG.js";import{S as I}from"./Canvas-C5qiJpk2.js";import{u as z}from"./useLazyStableRef-B5HeSgmi.js";import{B as f,A,M as _,a as D}from"./TopBar-7xEZzvoF.js";import{c as j,u as F}from"./Dropdown-B9h-t97s.js";import{u as U}from"./index-DcBgwC9u.js";import{M as $,S as O}from"./AdjustInstruments-2T0166Fg.js";import{S as q}from"./SongScrubBar-Bi4bL6LF.js";import{P as G}from"./PreviewIcon-BzqQjxfP.js";import{S as H}from"./SongPreview-C2g1F6yc.js";import"./common-wRUDMAM3.js";import"./index-Zv5TxpGm.js";import"./index-5h7t3GzQ.js";function V(s){const[o,r]=d.useState({loading:!0,error:!1});return d.useEffect(()=>{let t=!1;return r({loading:!0,error:!1}),k(s).then(()=>{t||r({loading:!1,error:!1})}).catch(i=>{t||(console.error(`Could not load synth. Error: ${i}`),r({loading:!1,error:!0}))}),()=>{t=!0}},[s]),{...o,synth:M(s)}}function X(s){return e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:s.size,height:s.size,...s,fill:"currentColor",viewBox:"0 0 16 16",children:[e.jsx("path",{d:"M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"}),e.jsx("path",{d:"M11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0"})]})}function W(s){return e.jsx("svg",{width:s.size,height:s.size,viewBox:"0 0 27 27",...s,children:e.jsx("rect",{x:"3",y:"3",width:"21",height:"21",className:"hover:fill-purple-hover fill-red-500"})})}/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],K=j("download",J);/**
 * @license lucide-react v0.542.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=[["path",{d:"M12 2v13",key:"1km8f5"}],["path",{d:"m16 6-4-4-4 4",key:"13yo43"}],["path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8",key:"1b2hhj"}]],Y=j("share",Q);function Z(s){navigator.clipboard?.writeText(s)}function ee(s){const o=T(s),r=new Blob([o],{type:"audio/midi"}),t=document.createElement("a");t.href=URL.createObjectURL(r),t.download="recording.mid",t.click()}function te({show:s=!0,onClose:o=()=>{},songMeta:r=void 0}){const{id:t,source:i}=r??{},a=C(),c=U();F("keydown",h=>{s&&h.key===" "&&h.preventDefault()});function m(){return a.stop(),o()}return!s||!t||!i?null:e.jsx($,{show:s&&!!t,onClose:m,className:"min-w-[min(100%,600px)]",children:e.jsxs("div",{className:"flex flex-col gap-3 p-8",children:[e.jsx("div",{className:"flex w-full flex-col whitespace-nowrap",children:e.jsx("span",{className:"text-2xl font-semibold",children:"Preview your recording"})}),e.jsxs("div",{className:"flex grow flex-col overflow-hidden rounded-md",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"pointer-events-none absolute z-20 h-full w-full rounded-md"}),e.jsx(q,{height:30})]}),e.jsxs("div",{style:{position:"relative",backgroundColor:"#2e2e2e",height:340,minHeight:340,width:"100%",overflow:"hidden"},onClick:()=>a.toggle,children:[e.jsx(G,{isLoading:!c.canPlay,isPlaying:c.playing,onPlay:h=>{h.stopPropagation(),a.play()}}),t&&i&&e.jsx(H,{songId:t,source:i})]}),e.jsx(I,{height:16}),e.jsxs("div",{className:"flex w-full gap-4",children:[e.jsxs("button",{className:"border-purple-primary hover:bg-purple-primary flex h-10 w-full cursor-pointer items-center justify-center gap-2 rounded-md border bg-white px-1 text-xl text-black transition hover:text-white",onClick:()=>{const p=`${window.location.origin}/play/?source=base64&id=${encodeURIComponent(t)}`;Z(p)},children:[e.jsx(Y,{}),"Copy Share URL"]}),e.jsxs("button",{className:"bg-purple-primary hover:bg-purple-hover flex h-10 w-full cursor-pointer items-center justify-center gap-2 rounded-md border-none px-1 text-xl text-white transition",onClick:()=>ee(t),children:[e.jsx(K,{}),"Download MIDI"]})]})]})]})})}function se({isError:s,isLoading:o,isRecordingAudio:r,value:t,onChange:i,onClickMidi:a,onClickRecord:c}){const m=r?"Stop recording":"Start recording audio";return e.jsxs("div",{className:"flex h-[50px] min-h-[50px] w-full items-center gap-4 bg-[#292929] px-4 text-2xl text-white transition",children:[e.jsx(f,{tooltip:"Back",children:e.jsx(S,{to:"/",children:e.jsx(A,{size:24})})}),e.jsx(f,{tooltip:m,className:"ml-auto",onClick:c,children:r?e.jsx(W,{size:24}):e.jsx(X,{size:24})}),e.jsx(f,{tooltip:"Choose a MIDI device",onClick:a,children:e.jsx(_,{size:24})}),e.jsx(O,{className:"h-3/4 max-w-fit text-base text-black",loading:o,error:s,value:t,onChange:i,options:P,format:v,display:v})]})}class oe{time=0;lastTime=0;raf;song;active;constructor(){this.time=Number.MAX_SAFE_INTEGER,this.lastTime=0,this.active=new Map,this.song={bpms:[],tracks:{1:{instrument:"piano"}},measures:[],notes:[],duration:0,items:[],keySignature:"C",ppq:480,ticksToSeconds:o=>o/480/2,secondsToTicks:o=>o*480*2},this.song.items=this.song.notes,E()&&this.loop()}start(){this.time=Number.MAX_SAFE_INTEGER,this.lastTime=Date.now(),this.active.clear(),this.loop()}stop(){typeof this.raf=="number"&&cancelAnimationFrame(this.raf)}loop(){this.raf=requestAnimationFrame(()=>{const o=Date.now(),r=o-this.lastTime;this.time-=r,this.lastTime=o;for(let[t,i]of this.active.entries()){let a=this.song.notes.find(c=>c.midiNote===t);a&&(a.time=this.getTime(),a.duration=i-a.time)}this.loop()})}addNote(o,r=80){const t=this.getTime(),i={midiNote:o,velocity:r,type:"note",track:1,time:t,duration:0,measure:0};this.song.notes.unshift(i),this.active.set(o,t)}releaseNote(o){this.active.delete(o)}getTime(){return this.time/1e3}}const ye=N(function(){const[o,r]=d.useState("acoustic_grand_piano"),t=V(o),i=z(()=>new oe),[a,c]=d.useState(!1),{isRecording:m,startRecording:h,stopRecording:p}=R(u),[g,x]=d.useState(""),w=d.useCallback((n,l=80)=>{t.synth.playNote(n,l),i.addNote(n,l)},[i,t.synth]),y=d.useCallback(n=>{t.synth.stopNote(n),i.releaseNote(n)},[i,t.synth]);return d.useEffect(()=>{const n=l=>{l.type==="up"?y(l.note):w(l.note,l.velocity)};return u.subscribe(n),()=>{u.unsubscribe(n)}},[w,y]),e.jsxs(e.Fragment,{children:[e.jsx("title",{children:"Free Play"}),e.jsxs("div",{className:"flex h-screen w-screen flex-col outline-none",...u.getListenerProps(),autoFocus:!0,children:[e.jsx(se,{onClickMidi:n=>{n.stopPropagation(),c(!a)},onClickRecord:n=>{if(n.stopPropagation(),!m)h();else{const l=p();if(l!==null){const b=B(l);x(b)}}},isRecordingAudio:m,isLoading:t.loading,isError:t.error,value:o,onChange:n=>r(n)}),e.jsx(D,{isOpen:a,onClose:()=>c(!1)}),e.jsx(te,{show:g.length>0,onClose:()=>x(""),songMeta:{source:"base64",id:g}}),e.jsx("div",{className:"relative grow",children:e.jsx(L,{song:i.song,config:{visualization:"falling-notes",noteLabels:"none"},hand:"both",handSettings:{1:{hand:"right"}},getTime:()=>i.getTime(),constrictView:!1})})]})]})});export{ye as default};
