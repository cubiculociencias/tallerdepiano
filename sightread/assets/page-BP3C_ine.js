import{p as n,L as ne,w as oe,a as x,t as re}from"./chunk-PVWAREVJ-BeAWct5i.js";import{v as O,D as ae,s as F,I as X,w as Y,x as V,y as ie,z as $,A as z,B as G,C as ce,u as Z,j as H,m as D,c as ee,r as le}from"./context-kPolJz0x.js";import{g as U,u as ue,C as de,c as me}from"./SongVisualizer-BApS7ggG.js";import{p as fe,S as W,e as ge}from"./Canvas-C5qiJpk2.js";import{u as he,C as pe}from"./useWakeLock-DSwNU-kK.js";import{C as xe,S as A}from"./AdjustInstruments-2T0166Fg.js";import{B as N,A as be,M as we,V as Me,a as Le}from"./TopBar-7xEZzvoF.js";import{p as je}from"./sound-effects-CW6uD0gu.js";import"./Dropdown-B9h-t97s.js";import"./common-wRUDMAM3.js";import"./index-Zv5TxpGm.js";import"./index-5h7t3GzQ.js";const ye=["emLow","gLow","emLow","gLow","emLow","gLow","gLow","emLow","emLow","gLow","emLow","gLow","emLow","gLow","gLow","emLow","emHigh","aHigh","emHigh","gHigh","emHigh","aHigh","gHigh","emHigh","emHigh","aHigh","emHigh","gHigh","emHigh","aHigh","gHigh","emHigh"],ke=["dLow","emLow","dLow","gLow","dLow","emLow","gLow","dLow","dLow","emLow","dLow","gLow","dLow","emLow","gLow","dLow","dHigh","emHigh","dHigh","gHigh","dHigh","emHigh","gHigh","dHigh","dHigh","emHigh","dHigh","gHigh","dHigh","emHigh","gHigh","dHigh"];function ve(s){const o=[];for(const e of s.notes)o[e.measure-1]??={duration:s.measures[e.measure-1].duration,number:e.measure,notes:[]},o[e.measure-1].notes.push(e);for(const e of o){let t=e.notes[0].time;for(const r of e.notes)r.time-=t}return o}function Se(s){if(!s)return{duration:0,notes:[],number:0};const o=s[0].duration;for(let r=1;r<s.length;r++)if(s[r].duration!==o)throw new Error("Not all measures have the same duration");const e=s[0].number,t=R(structuredClone(s.flatMap((r,c)=>r.notes.map(l=>({...l,track:c})))));return{duration:o,notes:t,number:e}}function He(s){const o=[],e=[];let t=0;for(const r of s){e.push({type:"measure",number:e.length,duration:r.duration,time:t});for(const c of structuredClone(r.notes))c.time+=t,o.push(c);t+=r.duration}return{notes:o,measures:e}}const Ne={aHigh:"A_High",amLow:"Am_Low",cHigh:"C_High",cLow:"C_Low",dHigh:"D_High",dLow:"D_Low",emHigh:"Em_High",emLow:"Em_Low",gHigh:"G_High",gLow:"G_Low"};async function q(s,o,e,t){const r=Ne[o];let c=`/music/irish/Right Hand/${r}_Lvl_${e}.mid`;if(t==="bass"){const l=r.slice(0,r.indexOf("_")),m=Math.min(2,e);c=`/music/irish/Left Hand/${l.toString()}_Lvl_${m}_LH.mid`}return fetch(c).then(l=>l.arrayBuffer()).then(l=>fe(new Uint8Array(l))).then(ve).catch(l=>(console.error(l),[]))}const Be=["DM (Full BPM 120 -2-2) v1.1 DB.mp3","DM (Full BPM 120) v1.1 DB.mp3","DM (Light Version BPM 120) v1.1 DB.mp3","DM (Piano Only BPM 120) v1.1 DB.mp3","DM (Strings Only BPM 120) v1.1 DB.mp3"],Ce=["EM (Full BPM 120) v1.0 DB.mp3","EM (Full Version BPM 120) v1.1 DB.mp3","EM (Percussion Only BPM 120) v1.1 DB.mp3","EM (Strings and Plucked BPM 120) v1.1 DB.mp3","EM (Strings Perc Choir BPM 120) v1.1 DB.mp3","EM (Strings Piano Plucked BPM 120) v1.1 DB.mp3"];async function Pe(s){const e=`/music/irish/Backing Tracks/${_(s==="eMinor"?Ce:Be)}`,t=new Audio(e),r=new ae;return t.addEventListener("canplaythrough",()=>r.resolve(t)),t.addEventListener("error",c=>r.reject(c)),r.promise}async function Ee(s,o=3,e){if(s==="random")return De(o,e);const t=Pe(s),r=s==="eMinor"?ye:ke,c=await Promise.all(r.map(async a=>{const[g,f]=await Promise.all([q("irish",a,o,"bass"),q("irish",a,o,"treble")]);return Se([_(g),_(f)])})),{notes:l,measures:m}=He(c);return{duration:m.reduce((a,g)=>a+g.duration,0),notes:l,measures:m,tracks:{0:{},1:{}},bpms:[],timeSignature:{numerator:6,denominator:8},keySignature:"C",items:R([...m,...l]),backing:await t,ppq:480,ticksToSeconds:a=>a/480/2,secondsToTicks:a=>a*480*2}}function De(s,o){const e={bass:{min:2,max:3},treble:{min:4,max:5}},t=10;let r=0;const c=[],l=[],m=s===1?1:s===2?.5:.25;for(;r<t;){const d={type:"note",time:r,duration:m-.05,measure:Math.floor(r/4)};if(o.bass){console.log("making bass");const{min:a,max:g}=e.bass;c.push({...d,track:1,midiNote:O(a,g,"C")})}if(o.treble){const{min:a,max:g}=e.treble;c.push({...d,track:0,midiNote:O(a,g,"C")})}r+=m}for(let d=0;d<t;d+=1){const a={type:"measure",number:l.length,time:d,duration:1};l.push(a)}return{duration:t,notes:c,measures:l,tracks:{0:{},1:{}},bpms:[],timeSignature:{numerator:4,denominator:4},keySignature:"C",items:R([...l,...c]),ppq:480,ticksToSeconds:d=>d/480/2,secondsToTicks:d=>d*480*2}}function R(s){return s.sort((o,e)=>o.time-e.time)}function _(s){if(!s||!s.length){console.log("shouldnt happen");return}return s[Math.floor(Math.random()*s.length)]}function J(){return typeof process<"u"&&!1}function Ae(s){const o=F(()=>[]),e=F(function(r){const[c,l,m]=r(o);m.has(e)&&(c.forEach(r),++l.n)});return e.effect=s,e.unstable_onInit=t=>{const r=new Set;let c=0,l=!1,m=!1,d=!1,a;function g(){if(c)return;r.clear();let p=!0;const I=u=>{if(d)return t.get(u);if(V(e,u)){const y=h(u);if(!ie(y))if($(u))z(u,u.init,h);else throw new Error("no atom init");return G(y)}const b=v(u);try{return G(b)}finally{S.d.set(u,b.n),L.get(u)?.t.add(e),p?r.add(u):L.has(u)&&(i(e),j(),k())}};I.peek=t.get;const E=(u,...b)=>{const y=h(u);try{if(++c,V(e,u)){if(!$(u))throw new Error("atom not writable");const te=y.n,se=b[0];z(u,se,h),i(u),te!==y.n&&(B.add(u),w.c?.(u),C(u));return}else return P(u,...b)}finally{p||(j(),k()),--c}};E.recurse=(u,...b)=>{if(d){if(J())throw new Error("set.recurse is not allowed in cleanup");return}try{return l=!0,i(e),E(u,...b)}finally{j(),l=!1,m&&(m=!1,g())}};try{a?.();const u=e.effect(I,E);if(typeof u!="function")return;a=()=>{if(!c)try{return p=!0,d=!0,u()}finally{p=!1,d=!1,a=void 0}}}finally{p=!1,r.forEach(u=>{S.d.set(u,h(u).n)}),i(e),j()}}const f=X(t),L=f[1],B=f[3],w=Y(f[6]),h=f[11],k=f[12],j=f[13],v=f[14],C=f[15],P=f[16],i=f[17],M=Te(t),S=h(e);S.v=void 0,Object.assign(t.get(o),[r,S,L]),w.m.add(e,function(){M.add(g),a&&M.delete(a)}),w.u.add(e,function(){M.delete(g),a&&M.add(a)}),w.c.add(e,function(){l?m=!0:M.add(g)})},J()&&(Object.defineProperty(o,"debugLabel",{get:()=>e.debugLabel?`${e.debugLabel}:ref`:void 0,configurable:!0,enumerable:!0}),o.debugPrivate=!0),e}const K=new WeakMap;function Te(s){const o=X(s),e=Y(o[6]);let t=K.get(s);return t||(t=new Set,K.set(s,t),e.f.add(function(){for(const c of t)t.delete(c),c()})),t}function _e({onClickMidi:s}){return n.jsxs("div",{className:"flex h-[50px] min-h-[50px] w-full items-center gap-4 bg-[#292929] px-8 text-2xl text-white transition",children:[n.jsx(N,{tooltip:"Back",children:n.jsx(ne,{to:"/",children:n.jsx(be,{size:24})})}),n.jsx("span",{className:"absolute left-1/2 -translate-x-1/2",children:"Training"}),n.jsx(N,{tooltip:"Choose a MIDI device",className:"ml-auto",onClick:s,children:n.jsx(we,{size:24})}),!ce()&&n.jsx(Me,{})]})}function Re(s,o,e){const[t,r]=x.useState(),[c,l]=x.useReducer(a=>a+1,0),m=e==="grand"||e==="bass",d=e==="grand"||e==="treble";return x.useEffect(()=>{Ee(s,o,{bass:m,treble:d}).then(a=>r(a)).catch(a=>console.error(a))},[s,o,c,e,m,d]),[t,l]}const Xe=oe(function(){const[o,e]=x.useState(U()),t=Z(),[r,c]=x.useState(!1),[l,m]=re({level:"0",clef:"treble",generator:"eMinor"});let d=Object.fromEntries(l);const a=d.clef,g=d.generator,[f,L]=Re(g,+d.level,a),B=H(t.score.accuracy),w=H(t.score.combined),h=H(t.score.streak),k=H(t.getBpmModifier()),v={bass:"left",grand:"both",treble:"right"}[a];t.setHand(v),Ae(i=>{i(t.score.error)!==0&&je()}),he(),ue(()=>t.stop());function C(){t.stop()}function P(){L()}return x.useEffect(()=>{function i(){t.play()}return D.subscribe(i),()=>D.unsubscribe(i)},[t]),x.useEffect(()=>{if(!f)return;const i=U(f);i.visualization="sheet",i.skipMissedNotes=!0,e(i),t.setSong(f,i)},[f,t,e]),n.jsxs(n.Fragment,{children:[n.jsx("title",{children:"Phrase Training"}),n.jsx(Le,{isOpen:r,onClose:()=>c(!1)}),n.jsxs("div",{className:ee("flex h-screen flex-col outline-none","h-[100dvh]"),autoFocus:!0,...D.getListenerProps(),children:[n.jsx(_e,{onClickMidi:i=>{i.stopPropagation(),c(!r)}}),n.jsxs("div",{className:"relative flex w-full justify-center gap-4 bg-gray-200 px-8 py-4",children:[n.jsxs("div",{className:"flex items-center gap-2 rounded-md bg-white p-2 whitespace-nowrap text-black",children:[n.jsxs("label",{children:["BPM ",le(k*100),"%"]}),n.jsx(N,{tooltip:"Increase BPM",onClick:()=>t.increaseBpm(),children:n.jsx(pe,{className:"hover:text-purple-primary text-black"})}),n.jsx(N,{tooltip:"Decrease BPM",onClick:()=>t.decreaseBpm(),children:n.jsx(xe,{className:"hover:text-purple-primary text-black"})})]}),n.jsx(A,{className:"max-w-fit",options:["random","eMinor","dMajor"],value:g,onChange:i=>m({...d,generator:i}),display:i=>({random:"Random",eMinor:"Irish Folk in E Minor",dMajor:"Irish Folk in D Major"})[i],format:i=>({random:"Random",eMinor:"Irish Folk in E Minor",dMajor:"Irish Folk in D Major"})[i]}),n.jsx(A,{className:"max-w-fit",options:["0","1","2","3"],value:d.level,onChange:i=>m({...l,level:i}),display:i=>`Level: ${i}`}),n.jsx(A,{className:"max-w-fit",options:["treble","bass","grand"],value:a,onChange:i=>m({...l,clef:i}),display:i=>({treble:"Treble",bass:"Bass",grand:"Grand"})[i],format:i=>({treble:"Treble",bass:"Bass",grand:"Grand"})[i]})]}),n.jsx(W,{height:24}),n.jsxs("div",{className:"flex h-[100px] w-full items-center justify-center gap-8",children:[n.jsx(Ie,{}),n.jsx(T,{label:"Accuracy",children:B+"%"}),n.jsx(T,{label:"Score",children:w}),n.jsx(T,{label:"Streak",children:h})]}),n.jsx(W,{height:32}),n.jsx("div",{className:"relative mx-auto h-[400px] w-[calc(100%-100px)] justify-center bg-white",children:n.jsx(de,{song:f,config:o,hand:v,handSettings:me(o),getTime:()=>t.getTime(),game:!0})}),n.jsxs("div",{className:"flex basis-0 items-center justify-center gap-4 text-white",children:[n.jsx(Q,{onClick:C,className:"border-purple-primary text-purple-primary hover:bg-purple-light border bg-white",children:"Replay"}),n.jsx(Q,{onClick:P,className:"bg-purple-primary hover:bg-purple-hover",children:"Next"})]})]})]})});function Ie(){const s=Z(),o=x.useRef(null);return ge(()=>{if(!o.current)return;const e=s.getTime()/s.getDuration()*100;o.current.style.width=`${e}%`}),n.jsxs("div",{className:"flex min-w-[150px] flex-col gap-2",children:[n.jsx("span",{className:"w-full text-xl font-semibold text-black",children:"Progress"}),n.jsxs("div",{className:"relative h-[40px] w-full",children:[n.jsx("div",{className:"absolute bottom-0 h-[34px] w-full rounded-r-3xl bg-gray-300"}),n.jsx("div",{style:{boxShadow:"inset 0px 2px 3px rgba(255, 255, 255, 0.4), inset 0px 7px 11px rgba(255, 255, 255, 0.25)"},className:"from-purple-darkest to-purple-primary absolute bottom-0 h-[34px] rounded-r-3xl bg-linear-to-r",ref:o})]})]})}function T(s){return n.jsxs("div",{className:"flex min-w-[150px] flex-col gap-2",children:[n.jsx("span",{className:"text-xl font-semibold text-black",children:s.label}),n.jsx("span",{className:"text-purple-primary text-4xl font-semibold",children:s.children})]})}function Q({children:s,...o}){return n.jsx("button",{...o,className:ee(o.className,"w-[100px] rounded-md px-2 py-2 text-xl transition"),children:s})}export{Xe as default};
